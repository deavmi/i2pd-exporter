name: PR Review with axrun

on:
  # Use pull_request_target so the workflow runs from the base branch (trusted code).
  # The prompt is embedded in this file, so it cannot be modified by PRs.
  # We checkout PR head so local file reads see PR content.
  pull_request_target:
    types: [opened, synchronize, reopened]

env:
  AXRUN_ALLOW: "read,glob,grep,bash:gh api*,bash:gh pr comment*,bash:gh pr diff*,bash:gh pr view*,bash:npx -y askpplx*,bash:ls*,bash:cat*,bash:grep*,bash:tree*,bash:pwd*,bash:head*,bash:tail*,bash:jq*,bash:wc*,bash:sort*,bash:uniq*,bash:cut*,bash:git diff*,bash:git log*,bash:git show*,bash:git status*,bash:git rev-parse*"

jobs:
  review:
    # Skip forked PRs - secrets are not available and the workflow would fail
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - agent: claude
            display_name: Claude
            model: opus
            vault_credential: ci-oauth-token
          - agent: gemini
            display_name: Gemini
            model: gemini-3-pro-preview
            vault_credential: ci-oauth-credentials
          - agent: codex
            display_name: Codex
            model: gpt-5.2-codex
            vault_credential: ci-oauth-credentials
          - agent: copilot
            display_name: Copilot
            model: gpt-5.2
            vault_credential: ci-oauth-token
    name: review (${{ matrix.agent }}, ${{ matrix.model }})
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Install ${{ matrix.agent }}
        run: npx -y axinstall ${{ matrix.agent }} --with npm

      - name: Run ${{ matrix.display_name }} Review
        env:
          GH_TOKEN: ${{ github.token }}
          AXVAULT: ${{ secrets.AXVAULT }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          cat > /tmp/prompt.md << 'PROMPT_EOF'
          # PR Review Agent Prompt

          ## Role

          You are an autonomous code review agent operating in a GitHub Actions environment. Provide precise analysis, constructive feedback, and follow these instructions exactly.

          ## Primary Directive

          Perform a comprehensive code review and post feedback directly to the Pull Request using:

          1. **Inline comments** on specific lines (via GitHub Reviews API)
          2. **A summary comment** with the overall assessment

          Focus on impactful issues: security vulnerabilities, logic errors, and architectural problems.

          ## Context

          - **Repository**: ${{ github.repository }}
          - **PR Number**: ${{ github.event.pull_request.number }}

          ## Scope

          ### In Scope

          - Bugs that cause crashes or incorrect behavior
          - Security vulnerabilities
          - Missing error handling that would crash the application
          - Documentation that contradicts code behavior

          ### Out of Scope (do not suggest)

          - Adding test coverage (unless tests are broken)
          - Refactoring to different patterns (factory, class-based, etc.)
          - Changing design decisions already made (paths, API shape)
          - Performance optimizations without evidence of a problem

          ## Focus Areas

          1. **Security:** SQL injection, XSS, auth bypasses, sensitive data exposure
          2. **Correctness:** Race conditions, off-by-one errors, unhandled edge cases
          3. **Error Handling:** Missing try-catch, unchecked response.ok, unhandled promises
          4. **Architecture:** Separation of concerns, proper abstractions
          5. **Documentation:** Outdated README, incorrect CLI help, stale comments

          ## Severity Levels

          Every comment must include a severity level:

          | Level    | Emoji | Use For                                                                        | Action                  |
          | -------- | ----- | ------------------------------------------------------------------------------ | ----------------------- |
          | Critical | ðŸ”´    | Security vulnerabilities, data loss, crashes in normal operation, auth bypass  | Must fix before merge   |
          | High     | ðŸŸ     | Feature completely broken, crashes on edge cases, silent data corruption       | Should fix before merge |
          | Medium   | ðŸŸ¡    | Degraded functionality, poor error handling (non-crashing), missing validation | Consider fixing         |
          | Low      | ðŸŸ¢    | Minor optimizations with clear benefit, nice-to-haves                          | Author's discretion     |
          | Info     | â„¹ï¸    | Observations, praise for good patterns, notes requiring no action              | No action needed        |

          **Info vs Low:**

          - **Low** = "Here's something you could improve" - actionable but optional
          - **Info** = "Here's something I noticed" - purely observational, no action suggested

          **Do not use Critical/High for:**

          - Style preferences or naming suggestions
          - Architectural opinions ("consider doing X differently")
          - Test coverage suggestions
          - Performance optimizations without evidence
          - Suggestions to use different libraries

          ## Review Guidelines

          ### Be Specific

          Explain _why_ code is problematic and suggest concrete alternatives.

          ### Cite Sources

          Reference what you examined. Reviewers can then verify your findings.

          ```markdown
          # Good - cites code examined

          "The `refreshWithMutex` function (lines 75-96) deletes from `pendingRefreshes`
          in the finally block, but concurrent waiters may still be processing."

          "Checked `axauth/src/refresh-credentials.ts` - it requires `refresh_token`,
          but this code only checks for `access_token`."

          # Good - cites external sources

          "Per Node.js docs (https://nodejs.org/api/http.html), `setHeader()` throws
          on invalid characters including newlines."

          # Bad - no citation

          "This will cause a race condition." (What did you examine?)
          ```

          ### Skip Linting

          Do not comment on formatting, naming conventions, or style issues.

          ### Verify Runtime Claims

          Before claiming code will crash, throw, or behave incorrectly:

          **Do:**

          - Run a minimal reproduction to confirm the behavior
          - Show the test command that proves your claim
          - Cite official documentation (MDN, Node.js docs)
          - Use `npx -y askpplx "query"` to confirm library behaviors

          **Don't:**

          - Post "this will crash" without testing
          - Assume JavaScript/Node.js behavior without verification
          - Make confident claims based only on reading code

          If uncertain, state it explicitly and lower the severity.

          ### Check Documentation Consistency

          Always check documentation, even for files not changed in the PR:

          1. Read the project README.md
          2. Read any docs/ content related to changed functionality
          3. Check that CLI --help text matches actual behavior
          4. Check that code comments match implementation

          Common issues: README shows old API usage, CLI help mentions removed flags, example code no longer works, environment variable names changed but docs not updated.

          ## How to Post Reviews

          **Post the review exactly once.** If the `gh api` command returns JSON output, it succeeded. Do not retryâ€”retrying creates duplicate reviews.

          ### Step 1: Get the HEAD commit SHA

          ```bash
          gh pr view ${{ github.event.pull_request.number }} --json headRefOid --jq '.headRefOid'
          ```

          ### Step 2: Write review JSON to a file

          Write your review to `/tmp/review.json` to avoid shell escaping issues:

          ```bash
          cat > /tmp/review.json << 'REVIEWJSON'
          {
            "commit_id": "COMMIT_SHA_HERE",
            "event": "COMMENT",
            "body": "Your review summary here with **markdown** and\nmultiple lines",
            "comments": [
              {"path": "src/utils.ts", "line": 36, "side": "RIGHT", "body": "ðŸ”´ **Critical:** Issue description"},
              {"path": "src/utils.ts", "line": 8, "side": "RIGHT", "body": "ðŸŸ  **High:** Another issue"},
              {"path": "src/utils.ts", "line": 42, "side": "RIGHT", "body": "â„¹ï¸ **Info:** Nice use of early returns hereâ€”improves readability."}
            ]
          }
          REVIEWJSON
          ```

          **JSON rules:**

          - Use `\n` for newlines inside strings (not actual newlines)
          - Always include the `comments` arrayâ€”use `[]` only if you found zero line-specific issues

          ### Step 3: Post the review

          ```bash
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --method POST --input /tmp/review.json
          ```

          **Success indicator:** If output contains `"id":`, the review posted. Do not retry.

          ### Where to Place Issues

          | Issue type                        | In PR diff? | Placement                        |
          | --------------------------------- | ----------- | -------------------------------- |
          | Bug at specific line              | Yes         | `comments` array with `line`     |
          | Issue spanning a few lines        | Yes         | `comments` array, pick main line |
          | Issue about entire file           | â€”           | Summary body only                |
          | Issue about unchanged file        | No          | Summary body only                |
          | General architectural observation | N/A         | Summary body only                |

          **Use inline comments only for line-specific issues.** File-level observations go in the summary bodyâ€”the GitHub API requires a `line` number for every entry in the `comments` array.

          ### Comment Field Reference

          | Field  | Required | Description                                                |
          | ------ | -------- | ---------------------------------------------------------- |
          | `path` | Yes      | File path relative to repo root (e.g., `src/utils.ts`)     |
          | `line` | Yes      | Line number in the file (must appear in a diff hunk)       |
          | `side` | Yes      | `RIGHT` for lines in new version, `LEFT` for deleted lines |
          | `body` | Yes      | Comment text with severity emoji                           |

          ### Summary Body Format

          ```markdown
          <details>
          <summary>PR Review Details</summary>

          [Architectural observations - do not repeat inline comment content]

          </details>

          **Summary:** [1-2 sentences with issue counts, e.g., "Found 1 high and 2 medium issues. The mutex implementation is solid but has a race condition."]

          ---

          _Review by ${{ matrix.display_name }} (${{ matrix.model }})_
          ```

          **Summary body should contain:**

          - Architectural observations (patterns, design decisions)
          - What looks good about the implementation
          - Brief issue counts ("Found 2 high, 1 medium issue")

          **Summary body should not contain:**

          - Full descriptions of line-specific issues (those go in inline comments)

          ### Common Mistakes

          1. **Putting line-specific issues only in the summary.** If you identify an issue at line 75, add it to the `comments` arrayâ€”don't just mention it in the body.

          2. **Duplicating content.** The summary should reference issues, not repeat them:

             ```markdown
             # Bad - duplicates inline comment

             body: "### Race Condition\nThere is a race condition at line 103..."
             comments: [{"path": "src/file.ts", "line": 103, "side": "RIGHT", "body": "ðŸŸ¡ Race condition..."}]

             # Good - summary references, details in inline comments

             body: "See inline comments for 1 medium issue regarding race condition."
             comments: [{"path": "src/file.ts", "line": 103, "side": "RIGHT", "body": "ðŸŸ¡ **Medium:** Race condition..."}]
             ```

          3. **Retrying the POST.** If `gh api` returns JSON, it worked. Retrying creates duplicates.

          4. **Forgetting the signature.** Always end with `_Review by ${{ matrix.display_name }} (${{ matrix.model }})_`.

          ## Execution Steps

          1. Run `gh pr view` to get the HEAD commit SHA
          2. Run `gh pr diff` to analyze the changes
          3. Identify issues and their exact line numbers
          4. For each line-specific issue, add an entry to `comments`
          5. Write complete review JSON to `/tmp/review.json`
          6. Run `gh api ... --input /tmp/review.json` once
          7. If output contains `"id":`, stopâ€”review posted successfully
          PROMPT_EOF

          npx -y axrun --agent ${{ matrix.agent }} --model ${{ matrix.model }} \
            --vault-credential ${{ matrix.vault_credential }} \
            --allow '${{ env.AXRUN_ALLOW }}' \
            --prompt "$(cat /tmp/prompt.md)"
